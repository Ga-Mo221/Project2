using UnityEngine;
using Photon.Pun;
using System.Collections.Generic;
using Photon.Realtime;
using System.Collections;

public class LoadGame : MonoBehaviourPunCallbacks
{
    [SerializeField] private List<Transform> spawnPoints;
    [SerializeField] private GameObject CastlePrefab;

    void Start()
    {
        if (SettingManager.Instance.getOnline())
        {
            Debug.Log($"LoadGame active on {PhotonNetwork.NickName} | ViewID: {photonView?.ViewID}");
            if (PhotonNetwork.IsMasterClient)
            {
                Debug.Log("üëë Master ph√¢n v·ªã tr√≠ spawn cho to√†n b·ªô player...");
                StartCoroutine(StartSpawn());
            }
        }
        else
        {
            Instantiate(CastlePrefab, spawnPoints[0].position, Quaternion.identity);
            Debug.Log("ƒê√£ T·ªça th√†nh ch√≠nh Th√†nh C√¥ng");
        }
    }

    private IEnumerator StartSpawn()
    {
        yield return new WaitForSeconds(3f);
        AssignSpawnPositions();
    }

    /// <summary>
    /// Master g·ª≠i index spawn cho t·ª´ng player
    /// </summary>
    private void AssignSpawnPositions()
    {
        int index = 0;

        foreach (Player p in PhotonNetwork.PlayerList)
        {
            int assignedIndex = index % spawnPoints.Count;
            Debug.Log($"üì¶ G·ª≠i v·ªã tr√≠ spawn {assignedIndex} cho {p.NickName}");
            photonView.RPC(nameof(ReceiveSpawnPosition), p, assignedIndex);
            index++;
        }
    }

    /// <summary>
    /// M·ªói client t·ª± nh·∫≠n v·ªã tr√≠ spawn v√† t·ª± t·∫°o object c·ªßa m√¨nh
    /// </summary>
    [PunRPC]
    private void ReceiveSpawnPosition(int index)
    {
        Vector3 pos = spawnPoints[index].position;

        Debug.Log($"üöÄ {PhotonNetwork.NickName} nh·∫≠n v·ªã tr√≠ spawn {index} t·∫°i {pos}");

        // M·ªói client ch·ªâ t·∫°o object cho ch√≠nh m√¨nh
        PhotonNetwork.Instantiate("A_MultiplayerSytem/Prefab/Player/House/Castle", pos, Quaternion.identity);
    }
}
